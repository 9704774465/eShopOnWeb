# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
name: EshopWebAPP-Practice
trigger:
- main
resources:
 repositories:
   - repository: self
     trigger: none
stages:
  - stage: Build 
    displayName: Build
    jobs:
     - job: Build
       pool:
         vmImage: ubuntu-latest
       steps:
          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'
              projects: '**/*.sln'
              feedsToUse: 'select'
            displayName: Restore
          - task: DotNetCoreCLI@2
            inputs:
              command: 'build'
              projects: '**/*.sln'
            displayName: Build
          - task: DotNetCoreCLI@2
            inputs:
              command: 'test'
              projects: 'tests/UnitTests/*.csproj'
            displayName: Unit-test
          - task: DotNetCoreCLI@2
            inputs:
              command: 'publish'
              publishWebProjects: true
              arguments: '-o $(Build.ArtifactStagingDirectory)'
            displayName: Publish
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'ReatialAPP'
            displayName: Publish Artifacts
  - stage: Deployment 
    displayName: dev_env
    jobs:
      - deployment: deploy
        environment: Dev_Env
        pool :
         vmImage: windows-latest
        strategy:
         runOnce:
          deploy:
           steps:
            - task: DownloadBuildArtifacts@1
              inputs:
               buildType: 'current'
               downloadType: 'single'
               artifactName: 'RetailAPP'
               downloadPath: '$(Build.ArtifactStagingDirectory)'
              displayName: download
            - task: AzureRmWebAppDeployment@4
              inputs:
               ConnectionType: 'AzureRM'
               azureSubscription: 'Free Trial(584ffed6-e0a8-459e-bd00-108503a0a213)'
               appType: 'bb2'
               WebAppName: 'blackberry1'
               packageForLinux: '$(System.DefaultWorkingDirectory)/**/web.zip'

         